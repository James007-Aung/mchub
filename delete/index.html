<!doctype html><html lang="en"><head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Delete Account – McHub</title>
    <link rel="stylesheet" href="/assets/css/site.css">
</head><body>
<div class="nav"><div class="container"><a class="brand" href="/">McHub</a><nav>
    <a href="/" data-path="/">Home</a>
    <a href="/about.html" data-path="/about.html">About</a>
    <a href="/store.html" data-path="/store.html">App Store</a>
    <a href="/privacy.html" data-path="/privacy.html">User Policy</a>
    <a href="/delete/" data-path="/delete">Delete Account</a>
</nav></div></div>

<main class="container">
    <h1>Delete my account</h1>
    <p class="muted">Verify your phone number used in the app, then confirm deletion.</p>

    <!-- Step 1: phone -->
    <div class="card" id="stepPhone">
        <h3>Step 1 — Verify phone</h3>
        <label>Phone number (E.164, e.g. +66912345678)</label>
        <input id="phone" type="tel" placeholder="+66123456789" />
        <div id="recaptcha-container" style="margin:12px 0"></div>
        <p><button class="btn primary" id="sendCodeBtn">Send code</button></p>
    </div>

    <!-- Step 2: code -->
    <div class="card" id="stepCode" style="display:none">
        <h3>Step 2 — Enter the 6-digit code</h3>
        <input id="code" type="text" inputmode="numeric" maxlength="6" />
        <p><button class="btn primary" id="verifyBtn">Verify</button></p>
    </div>

    <!-- Step 3: confirm delete -->
    <div class="card" id="stepConfirm" style="display:none">
        <h3>Step 3 — Confirm deletion</h3>
        <label><input type="checkbox" id="confirmChk"> I understand this will delete my account.</label>
        <p><button class="btn primary" id="deleteBtn" disabled>Delete my account now</button></p>
        <div id="okBox" class="notice ok" style="display:none"></div>
        <div id="errBox" class="notice err" style="display:none"></div>
    </div>
</main>

<div class="footer"><div class="container"><p class="muted">© <span id="y"></span> McHub.</p>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script></div></div>

<script src="/assets/js/site.js"></script>

<!-- Firebase v9 compat CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
    // ---- Your project config (public & safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBQUdEeRlC1zO6XlO-cy5FV2UL_-WXIEhQ",
      authDomain: "mchub-a0276.firebaseapp.com",
      projectId: "mchub-a0276",
      storageBucket: "mchub-a0276.firebasestorage.app",
      messagingSenderId: "21663216482",
      appId: "1:21663216482:web:bbcda649b6b22c4b4a723b",
      measurementId: "G-NFX4NZGFHM"
    };
    const CALLABLE_NAME = "deleteAccountAndDataWeb";
    const FUNCTIONS_REGION = "asia-southeast1";
    // ---------------------------------------------

    // Initialize and bind SDKs to this app instance (compat)
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const functions = app.functions(FUNCTIONS_REGION);

    // Use the device/browser language for SMS whenever possible. Without this
    // call the OTP messages may default to en-US. See
    // https://firebase.google.com/docs/auth/web/phone-auth#phone_auth_request_language
    auth.useDeviceLanguage();


    // === PATCH: robust reCAPTCHA handling (invisible) ===
    // Create the verifier and render to capture the widgetId.
    let confirmationResult = null;
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
    "recaptcha-container",
    {
      size: "invisible",
      callback: function () { /* solved automatically for invisible */ },
      "expired-callback": function () {
        // We'll call resetRecaptcha() on error paths below
      }
    }
  );

  // Store the widget id so we can truly reset later
  window.recaptchaWidgetId = null;
  window.recaptchaVerifier.render().then(function (id) {
    window.recaptchaWidgetId = id;
  });

  function resetRecaptcha() {
    try {
      if (window.grecaptcha &&
          typeof window.grecaptcha.reset === "function" &&
          window.recaptchaWidgetId !== null) {
        window.grecaptcha.reset(window.recaptchaWidgetId);
      }
    } catch (_) { /* not fatal */ }
  }
  // === end PATCH ===
  // helpers
  const stepPhone = document.getElementById("stepPhone");
  const stepCode = document.getElementById("stepCode");
  const stepConfirm = document.getElementById("stepConfirm");
  const okBox = document.getElementById("okBox");
  const errBox = document.getElementById("errBox");
  const show = (el) => (el.style.display = "block");
  const hide = (el) => (el.style.display = "none");
  const ok = (m) => {
    okBox.textContent = m;
    okBox.style.display = "block";
    errBox.style.display = "none";
  };
  const err = (m) => {
    errBox.textContent = m;
    errBox.style.display = "block";
    okBox.style.display = "none";
  };

  // Step 1: send OTP
  document.getElementById("sendCodeBtn").onclick = async () => {
    try {
      // Ensure the reCAPTCHA widget is rendered
      try { await window.recaptchaVerifier.render(); } catch (_) {}

      const phone = document.getElementById("phone").value.trim();
      if (!phone || phone.charAt(0) !== "+") {
        err("Please enter your phone number in +E.164 format.");
        resetRecaptcha();
        return;
      }

      // Trigger the invisible challenge explicitly
      try { await window.recaptchaVerifier.verify(); } catch (e) {
        // If verify fails (e.g., challenge error), surface and reset
        console.error("[sendCodeBtn] verify failed:", e && e.code, e && e.message);
        err("reCAPTCHA challenge failed. Please try again.");
        resetRecaptcha();
        return;
      }

      confirmationResult = await auth
        .signInWithPhoneNumber(phone, window.recaptchaVerifier);

      hide(stepPhone);
      show(stepCode);
    } catch (e) {
      console.error("[sendCodeBtn] failed:", e && e.code, e && e.message);
      // Helpful messages for common cases
      let msg = "Failed to send code. Check the phone number and try again.";
      if (e && e.code === "auth/invalid-phone-number") msg = "Invalid phone number format.";
      if (e && e.code === "auth/too-many-requests") msg = "Too many requests. Try again later.";
      err(msg);
      resetRecaptcha();
    }
  };

  // Step 2: verify OTP
  document.getElementById("verifyBtn").onclick = async () => {
    try {
      const code = document.getElementById("code").value.trim();
      if (!code || code.length < 6) {
        err("Please enter the 6-digit verification code.");
        return;
      }

      await confirmationResult.confirm(code);
      console.log("[auth] signed in as", auth.currentUser && auth.currentUser.uid);

      hide(stepCode);
      show(stepConfirm);

      document.getElementById("confirmChk").onchange = (e) => {
        document.getElementById("deleteBtn").disabled = !e.target.checked;
      };
    } catch (e) {
      console.error("[verifyBtn] failed:", e && e.code, e && e.message);
      let msg = "Invalid code. Try again.";
      if (e && e.code === "auth/invalid-verification-code") {
        msg = "Incorrect verification code.";
      }
      err(msg);
      resetRecaptcha();
    }
  };

  // Step 3: confirm deletion
  document.getElementById("deleteBtn").onclick = async () => {
    try {
      const callDelete = functions.httpsCallable(CALLABLE_NAME);
      const res = await callDelete({ source: "web" });
      const data = (res && res.data) || {};
      console.log("[deleteAccountAndDataWeb] response:", data);

      if (data.ok === true) {
        ok("Account deleted. You will be signed out.");
        const fallback = setTimeout(() => (location.href = "/"), 2500);

        auth.onAuthStateChanged((u) => {
          if (!u) {
            clearTimeout(fallback);
            location.href = "/";
          }
        });

        auth.signOut().catch((err) => {
          console.warn(
            "signOut() warning:",
            err && err.code,
            err && err.message
          );
        });
      } else {
        const code = data.errorCode || "unknown";
        const msg = data.errorMessage || "See console for details";
        err(`Deletion failed: ${code} — ${msg}`);
      }
    } catch (e) {
      console.error("[deleteAccountAndDataWeb] error:", e.code, e.message, e);
      err(`Deletion failed: ${e.code || "error"} — ${e.message || "See console"}`);
    }
  };
</script>
</body></html>
