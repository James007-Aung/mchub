<!doctype html><html lang="en"><head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Delete Account – MC Hub</title>
    <link rel="stylesheet" href="/assets/css/site.css">
    <!-- Reserve space for visible reCAPTCHA -->
    <style>
        #recaptcha-container {
          min-height: 78px;
        }
    </style>
</head><body>
<div class="nav"><div class="container"><a class="brand" href="/">MC Hub</a><nav>
    <a href="/" data-path="/">Home</a>
    <a href="/about.html" data-path="/about.html">About</a>
    <a href="/store.html" data-path="/store.html">App Store</a>
    <a href="/privacy.html" data-path="/privacy.html">User Policy</a>
    <a href="/delete/" data-path="/delete">Delete Account</a>
</nav></div></div>

<main class="container">
    <h1>Delete my account</h1>
    <p class="muted">Verify your phone number used in the app, then confirm deletion.</p>

    <!-- Step 1: phone -->
    <div class="card" id="stepPhone">
        <h3>Step 1 — Verify phone</h3>
        <label>Phone number (E.164, e.g. +66912345678)</label>
        <input id="phone" type="tel" placeholder="+66123456789" />
        <div id="recaptcha-container" style="margin:12px 0"></div>
        <p><button class="btn primary" id="sendCodeBtn">Send code</button></p>
    </div>

    <!-- Step 2: code -->
    <div class="card" id="stepCode" style="display:none">
        <h3>Step 2 — Enter the 6-digit code</h3>
        <input id="code" type="text" inputmode="numeric" maxlength="6" />
        <p><button class="btn primary" id="verifyBtn">Verify</button></p>
    </div>

    <!-- Step 3: confirm delete -->
    <div class="card" id="stepConfirm" style="display:none">
        <h3>Step 3 — Confirm deletion</h3>
        <label><input type="checkbox" id="confirmChk"> I understand this will delete my account.</label>
        <p><button class="btn primary" id="deleteBtn" disabled>Delete my account now</button></p>
        <div id="okBox" class="notice ok" style="display:none"></div>
        <div id="errBox" class="notice err" style="display:none"></div>
    </div>
</main>

<div class="footer"><div class="container"><p class="muted">© <span id="y"></span> MC Hub.</p>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script></div></div>

<script src="/assets/js/site.js"></script>

<!-- Firebase v9 compat CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
    // ---- Your project config (public & safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBQUdEeRlC1zO6XlO-cy5FV2UL_-WXIEhQ",
      authDomain: "mchub-a0276.firebaseapp.com",
      projectId: "mchub-a0276",
      storageBucket: "mchub-a0276.firebasestorage.app",
      messagingSenderId: "21663216482",
      appId: "1:21663216482:web:bbcda649b6b22c4b4a723b",
      measurementId: "G-NFX4NZGFHM"
    };
    const CALLABLE_NAME   = "deleteAccountAndDataWeb";
    const FUNCTIONS_REGION = "asia-southeast1";
    // ---------------------------------------------

    // Initialize (compat)
    const app       = firebase.initializeApp(firebaseConfig);
    const auth      = app.auth();
    const functions = app.functions(FUNCTIONS_REGION);
    auth.useDeviceLanguage();

// ===== UI helpers =====
    const stepPhone   = document.getElementById("stepPhone");
    const stepCode    = document.getElementById("stepCode");
    const stepConfirm = document.getElementById("stepConfirm");
    const okBox  = document.getElementById("okBox");
    const errBox = document.getElementById("errBox");
    const show = (el) => (el.style.display = "block");
    const hide = (el) => (el.style.display = "none");
    const ok  = (m) => { okBox.textContent = m; okBox.style.display = "block"; errBox.style.display = "none"; };
    const err = (m) => { errBox.textContent = m; errBox.style.display = "block"; okBox.style.display = "none"; };

    // ===== reCAPTCHA lifecycle (fresh each attempt) =====
    let confirmationResult = null;
    let recaptchaVerifier  = null;
    let recaptchaWidgetId  = null;

    // Set this to true temporarily to *see* the widget while debugging
    const RECAPTCHA_VISIBLE = true;

    function clearRecaptchaDOM() {
      const host = document.getElementById("recaptcha-container");
      if (!host) return;
      // Remove any previous iframe/widget DOM completely
      host.innerHTML = "";
    }

    async function destroyRecaptcha() {
      try { await recaptchaVerifier?.clear?.(); } catch (_) {}
      recaptchaVerifier = null;
      recaptchaWidgetId = null;
      clearRecaptchaDOM();
      // Also try to reset grecaptcha if present (best-effort)
      try { window.grecaptcha?.reset?.(); } catch (_) {}
    }

    async function createRecaptcha() {
      await destroyRecaptcha();
      recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        "recaptcha-container",
        {
          size: RECAPTCHA_VISIBLE ? "normal" : "invisible",
          callback: () => { /* solved (invisible auto) */ },
          "expired-callback": async () => {
            console.warn("[recaptcha] expired-callback");
            await destroyRecaptcha();
          }
        }
      );
      // Render once; capture widget id for optional manual resets
      recaptchaWidgetId = await recaptchaVerifier.render();
      return recaptchaVerifier;
    }

    async function verifyRecaptchaOrThrow() {
      // For invisible, verify() will trigger challenge as needed
      try {
        await recaptchaVerifier.verify();
        return true;
      } catch (e) {
        console.error("[recaptcha] verify failed:", e?.code, e?.message);
        throw e;
      }
    }

    function friendlyAuthError(code, fallback = "Failed. Please try again.") {
      switch (code) {
        case "auth/invalid-phone-number":   return "Invalid phone number format (+E.164).";
        case "auth/too-many-requests":      return "Too many attempts. Try later or switch network/number.";
        case "auth/quota-exceeded":         return "SMS quota exceeded. Use a test number during development.";
        case "auth/captcha-check-failed":
        case "auth/invalid-app-credential":
        case "auth/app-not-authorized":     return "reCAPTCHA/app verification failed. Refresh and try again.";
        case "auth/invalid-verification-code": return "Incorrect verification code.";
        default: return fallback;
      }
    }

    // ===== Step 1: Send OTP =====
    document.getElementById("sendCodeBtn").onclick = async () => {
      const btn   = document.getElementById("sendCodeBtn");
      const phone = document.getElementById("phone").value.trim();

      if (!phone || !phone.startsWith("+")) {
        err("Please enter your phone number in +E.164 format.");
        return;
      }

      btn.disabled = true;
      try {
        // Fresh verifier on every attempt (critical to avoid silent no-ops)
        await createRecaptcha();

        // For visible mode debugging, ensure render occurred; for invisible, verify performs the challenge
        await verifyRecaptchaOrThrow();

        console.log("[auth] sending OTP for", phone);
        confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);

        hide(stepPhone);
        show(stepCode);
        console.log("[auth] OTP sent (check Identity Toolkit logs for SendVerificationCode)");
      } catch (e) {
        console.error("[sendCodeBtn] error:", e?.code, e?.message, e);
        err(friendlyAuthError(e?.code, "Failed to send code. Check number and try again."));
        // Hard reset recaptcha for next attempt
        await destroyRecaptcha();
      } finally {
        btn.disabled = false;
      }
    };

    // ===== Step 2: Verify OTP =====
    document.getElementById("verifyBtn").onclick = async () => {
      const btn  = document.getElementById("verifyBtn");
      const code = document.getElementById("code").value.trim();

      if (code.length < 6) {
        err("Please enter the 6-digit verification code.");
        return;
      }

      btn.disabled = true;
      try {
        await confirmationResult.confirm(code);
        console.log("[auth] signed in as", auth.currentUser?.uid);

        hide(stepCode);
        show(stepConfirm);

        document.getElementById("confirmChk").onchange = (e) => {
          document.getElementById("deleteBtn").disabled = !e.target.checked;
        };
      } catch (e) {
        console.error("[verifyBtn] error:", e?.code, e?.message, e);
        err(friendlyAuthError(e?.code, "Invalid code. Try again."));
        // After a bad code, keep the session, but ensure next Send Code creates a fresh verifier
        await destroyRecaptcha();
      } finally {
        btn.disabled = false;
      }

    };

    // ===== Step 3: Confirm deletion (callable) =====
    document.getElementById("deleteBtn").onclick = async () => {
      const btn = document.getElementById("deleteBtn");
      btn.disabled = true;
      try {
        const callDelete = functions.httpsCallable(CALLABLE_NAME);
        const res  = await callDelete({ source: "web" });
        const data = res?.data || {};
        console.log("[deleteAccountAndDataWeb] response:", data);

        if (data.ok === true) {
          ok("Account deleted. You will be signed out.");
          try { await auth.signOut(); } catch (e) { console.warn("[signOut] warn:", e); }
          setTimeout(() => (location.href = "/"), 1200);
        } else {
          err(`Deletion failed: ${data.errorCode || "unknown"} — ${data.errorMessage || "See console for details"}`);
          btn.disabled = false;
        }
      } catch (e) {
        console.error("[deleteAccountAndDataWeb] error:", e?.code, e?.message, e);
        err(`Deletion failed: ${e?.code || "error"} — ${e?.message || "See console"}`);
        btn.disabled = false;

    }
  };

</script>
</body></html>
