<!doctype html><html lang="en"><head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Delete Account – McHub</title>
    <link rel="stylesheet" href="/assets/css/site.css">
    <!-- Reserve space for visible reCAPTCHA -->
    <style>
        #recaptcha-container {
          min-height: 78px;
        }
    </style>
</head><body>
<div class="nav"><div class="container"><a class="brand" href="/">McHub</a><nav>
    <a href="/" data-path="/">Home</a>
    <a href="/about.html" data-path="/about.html">About</a>
    <a href="/store.html" data-path="/store.html">App Store</a>
    <a href="/privacy.html" data-path="/privacy.html">User Policy</a>
    <a href="/delete/" data-path="/delete">Delete Account</a>
</nav></div></div>

<main class="container">
    <h1>Delete my account</h1>
    <p class="muted">Verify your phone number used in the app, then confirm deletion.</p>

    <!-- Step 1: phone -->
    <div class="card" id="stepPhone">
        <h3>Step 1 — Verify phone</h3>
        <label>Phone number (E.164, e.g. +66912345678)</label>
        <input id="phone" type="tel" placeholder="+66123456789" />
        <div id="recaptcha-container" style="margin:12px 0"></div>
        <p><button class="btn primary" id="sendCodeBtn">Send code</button></p>
    </div>

    <!-- Step 2: code -->
    <div class="card" id="stepCode" style="display:none">
        <h3>Step 2 — Enter the 6-digit code</h3>
        <input id="code" type="text" inputmode="numeric" maxlength="6" />
        <p><button class="btn primary" id="verifyBtn">Verify</button></p>
    </div>

    <!-- Step 3: confirm delete -->
    <div class="card" id="stepConfirm" style="display:none">
        <h3>Step 3 — Confirm deletion</h3>
        <label><input type="checkbox" id="confirmChk"> I understand this will delete my account.</label>
        <p><button class="btn primary" id="deleteBtn" disabled>Delete my account now</button></p>
        <div id="okBox" class="notice ok" style="display:none"></div>
        <div id="errBox" class="notice err" style="display:none"></div>
    </div>
</main>

<div class="footer"><div class="container"><p class="muted">© <span id="y"></span> McHub.</p>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script></div></div>

<script src="/assets/js/site.js"></script>

<!-- Firebase v9 compat CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
    // ---- Your project config (public & safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBQUdEeRlC1zO6XlO-cy5FV2UL_-WXIEhQ",
      authDomain: "mchub-a0276.firebaseapp.com",
      projectId: "mchub-a0276",
      storageBucket: "mchub-a0276.firebasestorage.app",
      messagingSenderId: "21663216482",
      appId: "1:21663216482:web:bbcda649b6b22c4b4a723b",
      measurementId: "G-NFX4NZGFHM"
    };
    const CALLABLE_NAME   = "deleteAccountAndDataWeb";
    const FUNCTIONS_REGION = "asia-southeast1";
    // ---------------------------------------------

    // Initialize (compat)
    const app       = firebase.initializeApp(firebaseConfig);
    const auth      = app.auth();
    const functions = app.functions(FUNCTIONS_REGION);
    auth.useDeviceLanguage();

      // ===== UI helpers =====
  const stepPhone   = document.getElementById("stepPhone");
  const stepCode    = document.getElementById("stepCode");
  const stepConfirm = document.getElementById("stepConfirm");
  const okBox  = document.getElementById("okBox");
  const errBox = document.getElementById("errBox");
  const phoneInput = document.getElementById("phone");
  const codeInput  = document.getElementById("code");
  const sendBtn    = document.getElementById("sendCodeBtn");
  const verifyBtn  = document.getElementById("verifyBtn");
  const deleteBtn  = document.getElementById("deleteBtn");
  const confirmChk = document.getElementById("confirmChk");

  const show = (el) => (el.style.display = "block");
  const hide = (el) => (el.style.display = "none");

  // ARIA live region feedback
  function ok(m)  { okBox.textContent = m; okBox.style.display="block"; okBox.setAttribute("aria-live","polite"); errBox.style.display="none"; }
  function err(m) { errBox.textContent = m; errBox.style.display="block"; errBox.setAttribute("aria-live","assertive"); okBox.style.display="none"; }

  function setBtn(btn, loading, nextText) {
    if (loading) {
      btn.dataset.text = btn.textContent;
      btn.textContent = nextText || "Working…";
      btn.disabled = true;
      btn.classList.add("is-loading");
    } else {
      btn.textContent = btn.dataset.text || btn.textContent;
      btn.disabled = false;
      btn.classList.remove("is-loading");
    }
  }

  function smoothScrollInto(el) {
    try { el.scrollIntoView({ behavior: "smooth", block: "start" }); } catch (_) {}
  }

  function gotoStep(step) {
    hide(stepPhone); hide(stepCode); hide(stepConfirm);
    if (step === 1) { show(stepPhone);  smoothScrollInto(stepPhone);  phoneInput?.focus(); }
    if (step === 2) { show(stepCode);   smoothScrollInto(stepCode);   codeInput?.focus(); }
    if (step === 3) { show(stepConfirm);smoothScrollInto(stepConfirm);confirmChk?.focus(); }
  }

  // ===== reCAPTCHA lifecycle (fresh each attempt) =====
let confirmationResult = null;
let recaptchaVerifier  = null;
let recaptchaWidgetId  = null;

// Keep visible once rendered, but DO NOT render until phone is valid + button clicked
const RECAPTCHA_VISIBLE = true;

function clearRecaptchaDOM() {
  const host = document.getElementById("recaptcha-container");
  if (host) host.innerHTML = "";
}

async function destroyRecaptcha() {
  try { await recaptchaVerifier?.clear?.(); } catch (_) {}
  recaptchaVerifier = null;
  recaptchaWidgetId = null;
  clearRecaptchaDOM();
  try { window.grecaptcha?.reset?.(); } catch (_) {}
}

async function createRecaptcha() {
  // Render only when we really need it (after phone is valid + click)
  await destroyRecaptcha();
  recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
    size: RECAPTCHA_VISIBLE ? "normal" : "invisible",
    callback: () => { /* solved */ },
    "expired-callback": async () => {
      console.warn("[recaptcha] expired");
      await destroyRecaptcha(); // leave box cleared; user can click again to re-render
    }
  });
  recaptchaWidgetId = await recaptchaVerifier.render();
  console.log("[recaptcha] rendered id:", recaptchaWidgetId);
  return recaptchaVerifier;
}

async function verifyRecaptchaOrThrow() {
  // Will wait until the visible checkbox/puzzle is solved
  await recaptchaVerifier.verify();
  return true;
}

function friendlyAuthError(code, fallback = "Failed. Please try again.") {
  switch (code) {
    case "auth/invalid-phone-number":   return "Invalid phone number format (+E.164).";
    case "auth/too-many-requests":      return "Too many attempts. Try later or switch network/number.";
    case "auth/quota-exceeded":         return "SMS quota exceeded. Use a test number during development.";
    case "auth/captcha-check-failed":
    case "auth/invalid-app-credential":
    case "auth/app-not-authorized":     return "CAPTCHA/app verification failed. Refresh and try again.";
    case "auth/invalid-verification-code": return "Incorrect verification code.";
    default: return fallback;
  }
}

// ===== Step 1: Send OTP =====
document.getElementById("sendCodeBtn").onclick = async () => {
  const btn   = document.getElementById("sendCodeBtn");
  const phone = document.getElementById("phone").value.trim();

  // 1) Require valid phone BEFORE showing CAPTCHA
  if (!phone || !phone.startsWith("+")) {
    err("Please enter your phone number in +E.164 format.");
    return;
  }

  btn.disabled = true;
  try {
    // 2) Create & show CAPTCHA ONLY NOW
    if (!recaptchaVerifier) {
      await createRecaptcha();
      ok("Please complete the CAPTCHA, then click 'Send code' again.");
      return; // user will solve & click again
    }

    // 3) Verify user solved it
    await verifyRecaptchaOrThrow();

    console.log("[auth] sending OTP for", phone);
    confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);

    hide(stepPhone);
    show(stepCode);
    console.log("[auth] OTP sent (check Identity Toolkit logs for SendVerificationCode)");
  } catch (e) {
    console.error("[sendCodeBtn] error:", e?.code, e?.message, e);
    err(friendlyAuthError(e?.code, "Failed to send code. Check number and try again."));
    await destroyRecaptcha(); // clear widget; next click re-renders
  } finally {
    btn.disabled = false;
  }
};
  
</script>
</body></html>
