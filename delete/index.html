<!doctype html><html lang="en"><head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Delete Account – McHub</title>
    <link rel="stylesheet" href="/assets/css/site.css">
    <!-- Reserve space for visible reCAPTCHA -->
    <style>
        #recaptcha-container {
          min-height: 78px;
        }
    </style>
</head><body>
<div class="nav"><div class="container"><a class="brand" href="/">McHub</a><nav>
    <a href="/" data-path="/">Home</a>
    <a href="/about.html" data-path="/about.html">About</a>
    <a href="/store.html" data-path="/store.html">App Store</a>
    <a href="/privacy.html" data-path="/privacy.html">User Policy</a>
    <a href="/delete/" data-path="/delete">Delete Account</a>
</nav></div></div>

<main class="container">
    <h1>Delete my account</h1>
    <p class="muted">Verify your phone number used in the app, then confirm deletion.</p>

    <!-- Step 1: phone -->
    <div class="card" id="stepPhone">
        <h3>Step 1 — Verify phone</h3>
        <label>Phone number (E.164, e.g. +66912345678)</label>
        <input id="phone" type="tel" placeholder="+66123456789" />
        <div id="recaptcha-container" style="margin:12px 0"></div>
        <p><button class="btn primary" id="sendCodeBtn">Send code</button></p>
    </div>

    <!-- Step 2: code -->
    <div class="card" id="stepCode" style="display:none">
        <h3>Step 2 — Enter the 6-digit code</h3>
        <input id="code" type="text" inputmode="numeric" maxlength="6" />
        <p><button class="btn primary" id="verifyBtn">Verify</button></p>
    </div>

    <!-- Step 3: confirm delete -->
    <div class="card" id="stepConfirm" style="display:none">
        <h3>Step 3 — Confirm deletion</h3>
        <label><input type="checkbox" id="confirmChk"> I understand this will delete my account.</label>
        <p><button class="btn primary" id="deleteBtn" disabled>Delete my account now</button></p>
        <div id="okBox" class="notice ok" style="display:none"></div>
        <div id="errBox" class="notice err" style="display:none"></div>
    </div>
</main>

<div class="footer"><div class="container"><p class="muted">© <span id="y"></span> McHub.</p>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script></div></div>

<script src="/assets/js/site.js"></script>

<!-- Firebase v9 compat CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
    // ---- Your project config (public & safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBQUdEeRlC1zO6XlO-cy5FV2UL_-WXIEhQ",
      authDomain: "mchub-a0276.firebaseapp.com",
      projectId: "mchub-a0276",
      storageBucket: "mchub-a0276.firebasestorage.app",
      messagingSenderId: "21663216482",
      appId: "1:21663216482:web:bbcda649b6b22c4b4a723b",
      measurementId: "G-NFX4NZGFHM"
    };
    const CALLABLE_NAME   = "deleteAccountAndDataWeb";
    const FUNCTIONS_REGION = "asia-southeast1";
    // ---------------------------------------------

    // Initialize (compat)
    const app       = firebase.initializeApp(firebaseConfig);
    const auth      = app.auth();
    const functions = app.functions(FUNCTIONS_REGION);
    auth.useDeviceLanguage();

      // ===== UI helpers =====
  const stepPhone   = document.getElementById("stepPhone");
  const stepCode    = document.getElementById("stepCode");
  const stepConfirm = document.getElementById("stepConfirm");
  const okBox  = document.getElementById("okBox");
  const errBox = document.getElementById("errBox");
  const phoneInput = document.getElementById("phone");
  const codeInput  = document.getElementById("code");
  const sendBtn    = document.getElementById("sendCodeBtn");
  const verifyBtn  = document.getElementById("verifyBtn");
  const deleteBtn  = document.getElementById("deleteBtn");
  const confirmChk = document.getElementById("confirmChk");

  const show = (el) => (el.style.display = "block");
  const hide = (el) => (el.style.display = "none");

  // ARIA live region feedback
  function ok(m)  { okBox.textContent = m; okBox.style.display="block"; okBox.setAttribute("aria-live","polite"); errBox.style.display="none"; }
  function err(m) { errBox.textContent = m; errBox.style.display="block"; errBox.setAttribute("aria-live","assertive"); okBox.style.display="none"; }

  function setBtn(btn, loading, nextText) {
    if (loading) {
      btn.dataset.text = btn.textContent;
      btn.textContent = nextText || "Working…";
      btn.disabled = true;
      btn.classList.add("is-loading");
    } else {
      btn.textContent = btn.dataset.text || btn.textContent;
      btn.disabled = false;
      btn.classList.remove("is-loading");
    }
  }

  function smoothScrollInto(el) {
    try { el.scrollIntoView({ behavior: "smooth", block: "start" }); } catch (_) {}
  }

  function gotoStep(step) {
    hide(stepPhone); hide(stepCode); hide(stepConfirm);
    if (step === 1) { show(stepPhone);  smoothScrollInto(stepPhone);  phoneInput?.focus(); }
    if (step === 2) { show(stepCode);   smoothScrollInto(stepCode);   codeInput?.focus(); }
    if (step === 3) { show(stepConfirm);smoothScrollInto(stepConfirm);confirmChk?.focus(); }
  }

  // ===== reCAPTCHA lifecycle (fresh each attempt) =====
  let confirmationResult = null;
  let recaptchaVerifier  = null;
  let recaptchaWidgetId  = null;

  // keep visible checkbox/puzzle per your decision
  const RECAPTCHA_VISIBLE = true;

  function clearRecaptchaDOM() {
    const host = document.getElementById("recaptcha-container");
    if (!host) return;
    host.innerHTML = "";
  }

  async function destroyRecaptcha() {
    try { await recaptchaVerifier?.clear?.(); } catch (_) {}
    recaptchaVerifier = null;
    recaptchaWidgetId = null;
    clearRecaptchaDOM();
    try { window.grecaptcha?.reset?.(); } catch (_) {}
  }

  async function createRecaptcha() {
    await destroyRecaptcha();
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
      size: RECAPTCHA_VISIBLE ? "normal" : "invisible",
      callback: () => { /* solved */ },
      "expired-callback": async () => {
        console.warn("[recaptcha] expired-callback");
        err("CAPTCHA expired. Please check the box again.");
        await destroyRecaptcha();
        await createRecaptcha();
      }
    });
    recaptchaWidgetId = await recaptchaVerifier.render();
    console.log("[recaptcha] rendered widget id:", recaptchaWidgetId);
    return recaptchaVerifier;
  }

  async function verifyRecaptchaOrThrow() {
    try {
      const token = await recaptchaVerifier.verify();
      console.log("[recaptcha] got token length:", (token || "").length);
      return true;
    } catch (e) {
      console.error("[recaptcha] verify failed:", e?.code, e?.message);
      throw e;
    }
  }

  function friendlyAuthError(code, fallback = "Failed. Please try again.") {
    switch (code) {
      case "auth/invalid-phone-number":       return "Invalid phone number format (+E.164).";
      case "auth/too-many-requests":          return "Too many attempts. Try later or switch number/network.";
      case "auth/quota-exceeded":             return "SMS quota exceeded. Use a test number while developing.";
      case "auth/captcha-check-failed":
      case "auth/invalid-app-credential":
      case "auth/app-not-authorized":         return "CAPTCHA/app verification failed. Refresh and try again.";
      case "auth/invalid-verification-code":  return "Incorrect verification code.";
      default: return fallback;
    }
  }

  // init first view
  gotoStep(1);
  createRecaptcha();

  // ===== Step 1: Send OTP =====
  sendBtn.onclick = async () => {
    const phone = phoneInput.value.trim();

    if (!phone || !phone.startsWith("+")) {
      err("Please enter your phone number in +E.164 format (e.g., +66912345678).");
      phoneInput.focus();
      return;
    }

    setBtn(sendBtn, true, "Sending…");
    errBox.style.display = "none"; okBox.style.display = "none";

    try {
      // fresh verifier every attempt
      await createRecaptcha();

      // user must tick the visible box (or puzzle) — verify will wait for it
      ok("Please check the CAPTCHA box if prompted…");
      await verifyRecaptchaOrThrow();

      console.log("[auth] sending OTP for", phone);
      confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);

      ok("Code sent! Please enter the 6-digit code.");
      gotoStep(2);
    } catch (e) {
      console.error("[sendCodeBtn] error:", e?.code, e?.message, e);
      err(friendlyAuthError(e?.code, "Failed to send code. Check number and try again."));
      await destroyRecaptcha();
      await createRecaptcha();
    } finally {
      setBtn(sendBtn, false);
    }
  };

  // allow Enter in phone to trigger send
  phoneInput.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") sendBtn.click();
  });

  // ===== Step 2: Verify OTP =====
  verifyBtn.onclick = async () => {
    const code = codeInput.value.trim();

    if (code.length < 6) {
      err("Please enter the 6-digit verification code.");
      codeInput.focus();
      return;
    }

    setBtn(verifyBtn, true, "Verifying…");
    errBox.style.display = "none";

    try {
      await confirmationResult.confirm(code);
      console.log("[auth] signed in as", firebase.auth().currentUser?.uid);

      ok("Phone verified. You can confirm deletion below.");
      gotoStep(3);
    } catch (e) {
      console.error("[verifyBtn] error:", e?.code, e?.message, e);
      err(friendlyAuthError(e?.code, "Invalid code. Try again."));
      await destroyRecaptcha();
      await createRecaptcha();
      gotoStep(1); // guide them to request a new code if needed
    } finally {
      setBtn(verifyBtn, false);
    }
  };

  // allow Enter in code to trigger verify
  codeInput.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") verifyBtn.click();
  });

  // enable delete button only when checkbox ticked
  confirmChk.onchange = (e) => { deleteBtn.disabled = !e.target.checked; };

  // ===== Step 3: Confirm deletion (callable) =====
  const CALLABLE_NAME   = "deleteAccountAndDataWeb";
  const FUNCTIONS_REGION = "asia-southeast1";
  const app       = firebase.app(); // already initialized above in your file
  const auth      = app.auth();
  const functions = app.functions(FUNCTIONS_REGION);
  auth.useDeviceLanguage();

  deleteBtn.onclick = async () => {
    setBtn(deleteBtn, true, "Deleting…");
    errBox.style.display = "none"; okBox.style.display = "none";

    try {
      const callDelete = functions.httpsCallable(CALLABLE_NAME);
      const res  = await callDelete({ source: "web" });
      const data = res?.data || {};
      console.log("[deleteAccountAndDataWeb] response:", data);

      if (data.ok === true) {
        ok("Account deleted. Signing you out…");
        try { await auth.signOut(); } catch (e) { console.warn("[signOut] warn:", e); }
        setTimeout(() => (location.href = "/"), 1200);
      } else {
        err(`Deletion failed: ${data.errorCode || "unknown"} — ${data.errorMessage || "See console for details"}`);
        setBtn(deleteBtn, false);
      }
    } catch (e) {
      console.error("[deleteAccountAndDataWeb] error:", e?.code, e?.message, e);
      err(`Deletion failed: ${e?.code || "error"} — ${e?.message || "See console"}`);
      setBtn(deleteBtn, false);
    }
  };
  
</script>
</body></html>
