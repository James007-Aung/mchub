<!doctype html><html lang="en"><head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Delete Account – McHub</title>
    <link rel="stylesheet" href="/assets/css/site.css">
</head><body>
<div class="nav"><div class="container"><a class="brand" href="/">McHub</a><nav>
    <a href="/" data-path="/">Home</a>
    <a href="/about.html" data-path="/about.html">About</a>
    <a href="/store.html" data-path="/store.html">App Store</a>
    <a href="/privacy.html" data-path="/privacy.html">User Policy</a>
    <a href="/delete/" data-path="/delete">Delete Account</a>
</nav></div></div>

<main class="container">
    <h1>Delete my account</h1>
    <p class="muted">Verify your phone number used in the app, then confirm deletion.</p>

    <!-- Step 1: phone -->
    <div class="card" id="stepPhone">
        <h3>Step 1 — Verify phone</h3>
        <label>Phone number (E.164, e.g. +66912345678)</label>
        <input id="phone" type="tel" placeholder="+66123456789" />
        <div id="recaptcha-container" style="margin:12px 0"></div>
        <p><button class="btn primary" id="sendCodeBtn">Send code</button></p>
    </div>

    <!-- Step 2: code -->
    <div class="card" id="stepCode" style="display:none">
        <h3>Step 2 — Enter the 6-digit code</h3>
        <input id="code" type="text" inputmode="numeric" maxlength="6" />
        <p><button class="btn primary" id="verifyBtn">Verify</button></p>
    </div>

    <!-- Step 3: confirm delete -->
    <div class="card" id="stepConfirm" style="display:none">
        <h3>Step 3 — Confirm deletion</h3>
        <label><input type="checkbox" id="confirmChk"> I understand this will delete my account.</label>
        <p><button class="btn primary" id="deleteBtn" disabled>Delete my account now</button></p>
        <div id="okBox" class="notice ok" style="display:none"></div>
        <div id="errBox" class="notice err" style="display:none"></div>
    </div>
</main>

<div class="footer"><div class="container"><p class="muted">© <span id="y"></span> McHub.</p>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script></div></div>

<script src="/assets/js/site.js"></script>

<!-- Firebase v9 compat CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
    // ---- Your project config (public & safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBQUdEeRlC1zO6XlO-cy5FV2UL_-WXIEhQ",
      authDomain: "mchub-a0276.firebaseapp.com",
      projectId: "mchub-a0276",
      storageBucket: "mchub-a0276.firebasestorage.app",
      messagingSenderId: "21663216482",
      appId: "1:21663216482:web:bbcda649b6b22c4b4a723b",
      measurementId: "G-NFX4NZGFHM"
    };
    const CALLABLE_NAME = "deleteAccountAndData";
    const FUNCTIONS_REGION = "asia-southeast1";
    // ---------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const functions = firebase.functions(undefined, FUNCTIONS_REGION);

    // Invisible reCAPTCHA for phone auth
    let confirmationResult = null;
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
      'recaptcha-container', { size: 'invisible' }
    );

    // helpers
    const stepPhone = document.getElementById('stepPhone');
    const stepCode = document.getElementById('stepCode');
    const stepConfirm = document.getElementById('stepConfirm');
    const okBox = document.getElementById('okBox');
    const errBox = document.getElementById('errBox');
    const show = el => el.style.display='block';
    const hide = el => el.style.display='none';
    const ok = m => { okBox.textContent=m; okBox.style.display='block'; errBox.style.display='none'; };
    const err = m => { errBox.textContent=m; errBox.style.display='block'; okBox.style.display='none'; };

    // Step 1: send OTP
    document.getElementById('sendCodeBtn').onclick = async () => {
      try {
        const phone = document.getElementById('phone').value.trim();
        confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
        hide(stepPhone); show(stepCode);
      } catch (e) { err("Failed to send code. Check number and try again."); }
    };

    // Step 2: verify OTP
    document.getElementById('verifyBtn').onclick = async () => {
      try {
        const code = document.getElementById('code').value.trim();
        await confirmationResult.confirm(code);
        console.log("[auth] signed in as", firebase.auth().currentUser && firebase.auth().currentUser.uid);
        hide(stepCode); show(stepConfirm);
        document.getElementById('confirmChk').onchange = (e)=>{
          document.getElementById('deleteBtn').disabled = !e.target.checked;
        };
      } catch (e) { err("Invalid code. Try again."); }
    };

    // Debugging surface the error in page UI
     document.getElementById('deleteBtn').onclick = async () => {
    try {
      const callDelete = functions.httpsCallable(CALLABLE_NAME);
      const res = await callDelete({ source: "web" });

      // Log full payload so we can see steps from the function
      console.log("[deleteAccountAndData] response:", res && res.data);

      // If the call didn't throw, it succeeded. Show success and sign out.
      ok("Account deleted. You will be signed out.");
      setTimeout(() => auth.signOut().then(() => location.href = "/"), 1500);
    } catch (e) {
      console.error("[deleteAccountAndData] error:", e.code, e.message, e);
      err(`Deletion failed: ${e.code || "error"} — ${e.message || "See console"}`);
    }
  };
</script>
</body></html>
