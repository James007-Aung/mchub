<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Redirecting…</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
        .hint { color:#444; margin-top:12px; }
    </style>
</head>
<body>
<h1 style="margin:0 0 8px 0;">Redirecting back to Telegram…</h1>
<p class="hint">
    If Telegram doesn’t open automatically, close this tab and return to your Telegram chat manually.
</p>

<script>
    const qp   = new URLSearchParams(location.search);
    const tok  = qp.get('token') || '';
    const oid  = qp.get('oid')   || '';
    const BOT  = "thai_forms_helper_bot"; // NO '@'

    // Deep-link payloads
    const ppcap  = `ppcap_${tok}_${oid}`;
    const deeplinkWeb = `https://t.me/${BOT}?start=${encodeURIComponent(ppcap)}`;
    const deeplinkApp = `tg://resolve?domain=${BOT}&start=${encodeURIComponent(ppcap)}`;
    const intentUrl   = `intent://resolve?domain=${BOT}&start=${encodeURIComponent(ppcap)}#Intent;scheme=tg;package=org.telegram.messenger;S.browser_fallback_url=${encodeURIComponent(deeplinkWeb)};end`;

    // === Single-shot guard ===
    let fired = false;
    function navigateOnce(url) {
      if (fired) return;
      fired = true;
      // Use replace() to avoid history clutter; then blank out to discourage back/second fire.
      location.replace(url);
      setTimeout(() => { try { location.replace('about:blank'); } catch(e){} }, 1500);
    }

    // Heuristic: prefer tg:// if supported; else intent on Android; else web t.me
    // We will attempt AT MOST ONE navigation thanks to the guard above.
    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isTelegramInApp = /Telegram/i.test(ua);

    // Some in-app browsers block tg://; the intent scheme works better on Android Chrome.
    if (isAndroid && !isTelegramInApp) {
      navigateOnce(intentUrl);
    } else {
      navigateOnce(deeplinkApp);
    }

    // As an absolute last resort (if the scheme is blocked), provide a manual link in the DOM below.
    // We do NOT auto-fire t.me after a delay anymore to avoid multiple /start hits.
</script>

<p class="hint" style="margin-top:16px;">
    Not opening? <a id="manual" href="#">Open in Telegram</a>
</p>
<script>
    const manual = document.getElementById('manual');
    manual.href = (navigator.userAgent||'').includes('Android') ? '<???intent???>'.replace('<???intent???>', '') || deeplinkWeb : deeplinkWeb;
</script>
</body>
</html>
