<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Redirecting back to Telegram…</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
        .hint { color:#444; margin-top:12px; }
    </style>
</head>
<body>
<h1 style="margin:0 0 8px 0;">Redirecting back to Telegram…</h1>
<p class="hint">
    If Telegram doesn’t open automatically, tap the blue button below to open Telegram and return to your chat manually.
</p>

<script>
    const qp   = new URLSearchParams(location.search);
    const tok  = qp.get('token') || '';
    const oid  = qp.get('oid')   || '';
    const BOT  = "thai_forms_helper_bot";

    const ppcap  = `ppcap_${tok}_${oid}`;
    const deeplinkApp = `tg://resolve?domain=${BOT}&start=${encodeURIComponent(ppcap)}`;
    const deeplinkWeb = `https://t.me/${BOT}?start=${encodeURIComponent(ppcap)}`;
    const intentUrl   = `intent://resolve?domain=${BOT}&start=${encodeURIComponent(ppcap)}#Intent;scheme=tg;package=org.telegram.messenger;S.browser_fallback_url=${encodeURIComponent(deeplinkWeb)};end`;

    // Single-shot guard
    let fired = false;
    function navigateOnce(url) {
      if (fired) return;
      fired = true;
      location.replace(url);
      setTimeout(() => { try { location.replace('about:blank'); } catch(e){} }, 1500);
    }

    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isTelegramInApp = /Telegram/i.test(ua);
    const isMobile = /Android|iPhone|iPad/i.test(ua);

    if (isMobile && !isTelegramInApp) {
      // Outside Telegram: Android → intent://, iOS → tg://
      if (isAndroid) {
        navigateOnce(intentUrl);
      } else {
        navigateOnce(deeplinkApp);
      }
    } else if (isMobile && isTelegramInApp) {
      try {
        // Update copy to reassure users (works for both iOS & Android in-app).
        const p = document.querySelector('.hint');
        if (p) p.textContent = 'Payment confirmed. Returning to Telegram…';
        if (document && document.title) {
          document.title = 'Payment confirmed — returning to Telegram';
        }
        // Auto-close/blank the webview shortly after capture fires.
        // window.close() may be blocked, so also fall back to about:blank.
        setTimeout(() => {
          try { window.close(); } catch (e) {}
          try { location.replace('about:blank'); } catch (e) {}
        }, 900);
      } catch (_) {}
    } else {

      // Desktop: show button, open tg:// on click, cancel fallback if app opens
      document.write(`
        <div style="margin-top:24px;">
          <p style="font-size:16px;margin-bottom:12px;">
            ✅ Click below to confirm your payment in Telegram:
          </p>
          <a id="openTgBtn" href="${deeplinkApp}"
             style="display:inline-block;padding:12px 18px;background:#0088cc;color:#fff;
                    font-size:18px;font-weight:600;text-decoration:none;border-radius:6px;">
             Open in Telegram
          </a>
        </div>
      `);

      window.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('openTgBtn');
        if (!btn) return;

        btn.addEventListener('click', () => {
          let fallbackTimer = setTimeout(() => {
            try { window.location.href = deeplinkWeb; } catch (e) {}
          }, 1500);

          const cancelFallback = () => {
            clearTimeout(fallbackTimer);
            window.removeEventListener('blur', cancelFallback);
            window.removeEventListener('pagehide', cancelFallback);
            document.removeEventListener('visibilitychange', onVis);
          };
          const onVis = () => {
            if (document.visibilityState === 'hidden') cancelFallback();
          };

          // Cancel fallback if Telegram took focus
          window.addEventListener('blur', cancelFallback);
          window.addEventListener('pagehide', cancelFallback);
          document.addEventListener('visibilitychange', onVis);
        }, { once: true });
      });
    }
</script>

</body>
</html>
